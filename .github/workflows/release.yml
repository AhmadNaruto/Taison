name: Release
on:
  push:
    tags:
      - v*
  workflow_dispatch:
    inputs:
      release_ref:
        description: "Release TAG"
        required: true

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  initialize:
    name: "Initialize deploy"
    runs-on: ubuntu-latest
    timeout-minutes: 2
    outputs:
      tag: ${{ steps.get_tag.outputs.tag }}
    steps:
      - name: Get tag
        id: get_tag
        run: |
          if [[ "${{ github.event_name }}" = "push" && "${{ github.ref_type }}" = "tag" ]]; then
            TAG="${GITHUB_REF#refs/tags/}"
          elif [[ -n "${{ github.event.inputs.release_ref }}" ]]; then
            TAG="${{ github.event.inputs.release_ref }}"
          else
            TAG="${GITHUB_REF#refs/tags/}"
          fi
          echo "tag=$TAG" >> $GITHUB_OUTPUT

  build:
    if: github.repository == 'AhmadNaruto/Taison'
    name: Build
    runs-on: 'ubuntu-latest'
    needs: initialize

    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Set up JDK
        uses: actions/setup-java@v5
        with:
          java-version: 21
          distribution: temurin

      - name: Set up Gradle
        uses: gradle/actions/setup-gradle@v5

      - name: Build
        run: ./gradlew assembleRelease -Pinclude-telemetry -Penable-updater

      - name: Debug - List APK files before signing
        run: find app/build/outputs/apk -name "*.apk" -type f | xargs ls -la

      - name: Sign APK
        uses: r0adkll/sign-android-release@v1
        with:
          releaseDirectory: app/build/outputs/apk/release
          signingKeyBase64: ${{ secrets.SIGNING_KEY }}
          alias: ${{ secrets.ALIAS }}
          keyStorePassword: ${{ secrets.KEY_STORE_PASSWORD }}
          keyPassword: ${{ secrets.KEY_PASSWORD }}
        env:
          BUILD_TOOLS_VERSION: '35.0.1'

      - name: Debug - List APK files after signing
        run: |
          echo "=== Signed APK files ==="
          find app/build/outputs/apk -name "*.apk" -type f | xargs ls -la

      - name: Find and rename APK files
        run: |
          TAG="${{ needs.initialize.outputs.tag }}"
          RELEASE_DIR="app/build/outputs/apk/release"

          echo "Looking for APK files in: $RELEASE_DIR"

          # Cari semua file APK yang sudah ditandatangani
          for apk_file in "$RELEASE_DIR"/*-signed.apk "$RELEASE_DIR"/*-unsigned-signed.apk; do
            if [ -f "$apk_file" ]; then
              echo "Found APK: $apk_file"
              filename=$(basename "$apk_file")

              # Tentukan nama baru berdasarkan pola nama
              case $filename in
                *universal*)
                  new_name="taison-$TAG.apk"
                  ;;
                *arm64*)
                  new_name="taison-arm64-v8a-$TAG.apk"
                  ;;
                *armeabi*)
                  new_name="taison-armeabi-v7a-$TAG.apk"
                  ;;
                *x86_64*)
                  new_name="taison-x86_64-$TAG.apk"
                  ;;
                *x86*)
                  new_name="taison-x86-$TAG.apk"
                  ;;
                *)
                  new_name="taison-$TAG.apk"
                  ;;
              esac

              echo "Renaming $filename to $new_name"
              mv "$apk_file" "$new_name"
            fi
          done

          echo "=== Final APK files ==="
          ls -la *.apk 2>/dev/null || echo "No APK files found"

      - name: Upload APK
        uses: actions/upload-artifact@v5
        with:
          name: taison-release
          path: |
            taison-*.apk
          if-no-files-found: ignore

  build_foss:
    if: github.repository == 'AhmadNaruto/Taison'
    name: Build (FOSS)
    runs-on: ubuntu-latest
    needs: initialize

    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Set up JDK
        uses: actions/setup-java@v5
        with:
          java-version: 21
          distribution: temurin

      - name: Set up Gradle
        uses: gradle/actions/setup-gradle@v5

      - name: Build
        run: ./gradlew assembleFoss -Penable-updater

      - name: Debug - List FOSS APK files before signing
        run: |
          echo "=== FOSS APK files before signing ==="
          find app/build/outputs/apk/foss -name "*.apk" -type f 2>/dev/null | xargs ls -la || echo "No FOSS APK files found"

      - name: Sign APK
        uses: r0adkll/sign-android-release@v1
        with:
          releaseDirectory: app/build/outputs/apk/foss
          signingKeyBase64: ${{ secrets.SIGNING_KEY }}
          alias: ${{ secrets.ALIAS }}
          keyStorePassword: ${{ secrets.KEY_STORE_PASSWORD }}
          keyPassword: ${{ secrets.KEY_PASSWORD }}
        env:
          BUILD_TOOLS_VERSION: '35.0.1'

      - name: Debug - List FOSS APK files after signing
        run: |
          echo "=== Signed FOSS APK files ==="
          find app/build/outputs/apk/foss -name "*.apk" -type f 2>/dev/null | xargs ls -la || echo "No signed FOSS APK files found"

      - name: Find and rename FOSS APK
        run: |
          TAG="${{ needs.initialize.outputs.tag }}"
          FOSS_DIR="app/build/outputs/apk/foss"

          echo "Looking for FOSS APK in: $FOSS_DIR"

          # Cari file FOSS APK yang sudah ditandatangani
          FOSS_APK=$(find "$FOSS_DIR" -name "*.apk" -type f 2>/dev/null | head -1)

          if [ -n "$FOSS_APK" ]; then
            echo "Found FOSS APK: $FOSS_APK"
            mv "$FOSS_APK" "taison-$TAG-foss.apk"
            echo "Renamed to: taison-$TAG-foss.apk"
          else
            echo "No FOSS APK found"
          fi

          echo "=== Final FOSS APK ==="
          ls -la *foss*.apk 2>/dev/null || echo "No FOSS APK files"

      - name: Upload FOSS APK
        uses: actions/upload-artifact@v5
        with:
          name: taison-foss
          path: |
            *foss*.apk
          if-no-files-found: warn

  release:
    name: Create GitHub Release
    runs-on: ubuntu-24.04
    needs: [initialize, build, build_foss]

    steps:
      - name: Download artifacts
        uses: actions/download-artifact@v5
        with:
          path: artifacts

      - name: List downloaded files
        run: |
          echo "=== Downloaded artifacts ==="
          find artifacts -type f -name "*.apk" | xargs ls -la

      - name: Prepare release files
        run: |
          TAG="${{ needs.initialize.outputs.tag }}"
          mkdir -p release_files

          # Copy semua file APK ke folder release_files
          find artifacts -name "*.apk" -type f -exec cp {} release_files/ \;

          echo "=== Files ready for release ==="
          ls -la release_files/

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ needs.initialize.outputs.tag }}
          name: Taison ${{ needs.initialize.outputs.tag }}
          body: |
            ## Release Notes

            Check out the [past release notes](https://github.com/AhmadNaruto/Taison/releases) if you're upgrading from an earlier version.

            > **Tip:** If you are unsure which version to download then go with `taison-${{ needs.initialize.outputs.tag }}.apk`

            ### Files included:
            - `taison-${{ needs.initialize.outputs.tag }}.apk` - Universal APK (recommended for most users)
            - `taison-${{ needs.initialize.outputs.tag }}-foss.apk` - FOSS version (without proprietary components)
            - Architecture-specific APKs for better performance on specific devices
          files: release_files/*
          draft: false
          prerelease: false
          generate_release_notes: true
          token: ${{ secrets.GITHUB_TOKEN }}
